<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🚀 Real-Debrid Manager</title>
  
  <!-- PWA 필수 태그들 -->
  <meta name="theme-color" content="#007bff"/>
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <!-- (매우 중요) 매니페스트 파일 경로 -->
  <link rel="manifest" href="./manifest.json">

  <style>
    /* 스타일은 이전과 동일 */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f4f4f4; color: #333; }
    .container { max-width: 800px; margin: auto; }
    h1, h2 { color: #1a1a1a; }
    input, button, textarea { margin: 10px 0; padding: 12px; width: 100%; box-sizing: border-box; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
    button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
    button:hover { background-color: #0056b3; }
    .section { margin-bottom: 30px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
<div class="container">
  <h1>🚀 Real-Debrid Manager</h1>
  
  <div class="section">
    <h2>🔑 API Token Settings</h2>
    <input type="password" id="apiToken" placeholder="Enter your Real-Debrid API token" />
    <button onclick="saveToken()">💾 Save API Token</button>
  </div>
  
  <div class="section">
    <h2>🔗 Paste Magnet Link</h2>
    <textarea id="magnetInput" placeholder="Paste magnet link here..." rows="4"></textarea>
    <button onclick="uploadMagnet()">Upload Magnet</button>
  </div>

  <div class="section">
    <h2>📁 Upload Torrent File</h2>
    <input type="file" id="torrentFile" accept=".torrent" />
    <button onclick="uploadTorrent()">Upload Torrent</button>
  </div>
</div>

<script>
    // (매우 중요) 서비스 워커 경로
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => {
          console.log('ServiceWorker registration successful');
        }).catch(err => {
          console.error('ServiceWorker registration failed: ', err);
        });
      });
    }

    // 나머지 스크립트는 이전과 동일
    document.addEventListener('DOMContentLoaded', () => {
        const savedToken = localStorage.getItem('rdToken');
        if (savedToken) { document.getElementById('apiToken').value = savedToken; }
    });
    function saveToken() {
        const token = document.getElementById('apiToken').value;
        if(token) { localStorage.setItem('rdToken', token); alert('Token saved!'); }
        else { alert('Please enter a token.'); }
    }
    function getToken() { return localStorage.getItem('rdToken'); }

    async function uploadMagnet() {
        const magnet = document.getElementById('magnetInput').value.trim();
        const token = getToken();
        if (!token) return alert('API Token is missing.');
        if (!magnet) return;

        try {
            const res = await fetch('/api/torrents/addMagnet', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `magnet=${encodeURIComponent(magnet)}`
            });
            const data = await res.json();
            if (res.ok) { alert('Magnet link successfully added!'); document.getElementById('magnetInput').value = ''; }
            else { throw new Error(data.error || 'Unknown error'); }
        } catch (err) { alert(`❌ Error: ${err.message}`); }
    }

    async function uploadTorrent() {
        const fileInput = document.getElementById('torrentFile');
        const token = getToken();
        if (!token) return alert('API Token is missing.');
        if (!fileInput.files.length) return alert('No torrent file selected.');
        const file = fileInput.files[0];

        try {
            const res = await fetch('/api/torrents/addTorrent', {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` },
                body: file
            });
            if (res.status === 201) { alert('Torrent file successfully uploaded!'); fileInput.value = ''; }
            else { const errorData = await res.json(); throw new Error(`[${res.status}] ${errorData.error || res.statusText}`); }
        } catch (err) { alert(`❌ Error: ${err.message}`); }
    }
</script>
</body>
</html>
